<!DOCTYPE html>
<html lang="en" data-theme="dark-poole">
  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
    
      Snapchat: not for state secrets &middot; kivikakk.ee
    
  </title>

  <link rel="stylesheet" href="/styles.css">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/ashe-icon-144.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">
  <link rel="alternate" type="application/atom+xml" title="kivikakk.ee" href="/atom.xml">

  <meta name="theme-color" content="#3E2349">

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="Snapchat: not for state secrets" />
<meta name="author" content="Asherah Connor" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I use Snapchat. It’s an app where you can take a photo or short (&lt; 10 second) video and send it to your friends who use the service; they’ll then be able to see it, once, before it disappears forever. Ostensibly, the app is for sexting, because there’s no fear that your photo will get spread around (no forwarding/etc.) or retained for longer than you’d like, but it seems like it’s not as much a sexter’s hangout as the media might want you to think. My circle of friends use it basically as an extension of weird Twitter – most snaps I send and receive are strange angles of weird objects; the completely mundane but somehow therapeutic (7 seconds of the camera pointed outside the window of a tram, pointed at the ground moving below); or just closeups of Curtis Stone’s face, wherever we see him. Of course, the promise that they won’t get retained is just that: a promise. Since your phone receives this image and shows it to you at some point, it must be downloaded by your phone. If it can be downladed by the phone, it can be downloaded by something else. We decided to find out how." />
<meta property="og:description" content="I use Snapchat. It’s an app where you can take a photo or short (&lt; 10 second) video and send it to your friends who use the service; they’ll then be able to see it, once, before it disappears forever. Ostensibly, the app is for sexting, because there’s no fear that your photo will get spread around (no forwarding/etc.) or retained for longer than you’d like, but it seems like it’s not as much a sexter’s hangout as the media might want you to think. My circle of friends use it basically as an extension of weird Twitter – most snaps I send and receive are strange angles of weird objects; the completely mundane but somehow therapeutic (7 seconds of the camera pointed outside the window of a tram, pointed at the ground moving below); or just closeups of Curtis Stone’s face, wherever we see him. Of course, the promise that they won’t get retained is just that: a promise. Since your phone receives this image and shows it to you at some point, it must be downloaded by your phone. If it can be downladed by the phone, it can be downloaded by something else. We decided to find out how." />
<link rel="canonical" href="https://kivikakk.ee/2013/05/10/snapchat/" />
<meta property="og:url" content="https://kivikakk.ee/2013/05/10/snapchat/" />
<meta property="og:site_name" content="kivikakk.ee" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2013-05-10T13:44:00+03:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Snapchat: not for state secrets" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Asherah Connor","url":"https://kivikakk.ee"},"dateModified":"2013-05-10T13:44:00+03:00","datePublished":"2013-05-10T13:44:00+03:00","description":"I use Snapchat. It’s an app where you can take a photo or short (&lt; 10 second) video and send it to your friends who use the service; they’ll then be able to see it, once, before it disappears forever. Ostensibly, the app is for sexting, because there’s no fear that your photo will get spread around (no forwarding/etc.) or retained for longer than you’d like, but it seems like it’s not as much a sexter’s hangout as the media might want you to think. My circle of friends use it basically as an extension of weird Twitter – most snaps I send and receive are strange angles of weird objects; the completely mundane but somehow therapeutic (7 seconds of the camera pointed outside the window of a tram, pointed at the ground moving below); or just closeups of Curtis Stone’s face, wherever we see him. Of course, the promise that they won’t get retained is just that: a promise. Since your phone receives this image and shows it to you at some point, it must be downloaded by your phone. If it can be downladed by the phone, it can be downloaded by something else. We decided to find out how.","headline":"Snapchat: not for state secrets","mainEntityOfPage":{"@type":"WebPage","@id":"https://kivikakk.ee/2013/05/10/snapchat/"},"url":"https://kivikakk.ee/2013/05/10/snapchat/"}</script>
<!-- End Jekyll SEO tag -->

</head>


  <body>
    <div class="container content">
      <header class="masthead">
        <h3 class="masthead-title">
          <a href="/" title="Home">kivikakk.ee</a>

          <nav class="nav">
            
            <small><a href="/">Home</a></small>
            
            <small><a href="/about/">About</a></small>
            
            <small><a href="/index/">Index</a></small>
            
          </nav>
        </h3>
      </header>

      <main>
        <article class="post">
  <h1 class="post-title">Snapchat: not for state secrets</h1>
  <time datetime="2013-05-10T13:44:00+03:00" class="post-date">10 May 2013</time>
  <p>I use <a href="http://www.snapchat.com/">Snapchat</a>.  It’s an app where you can take a
photo or short (&lt; 10 second) video and send it to your friends who use the
service; they’ll then be able to see it, once, before it disappears forever.</p>

<p>Ostensibly, the app is for sexting, because there’s no fear that your photo
will get spread around (no forwarding/etc.) or retained for longer than you’d
like, but it <a href="http://survata.com/blog/is-snapchat-only-used-for-sexting-we-asked-5000-people-to-find-out/">seems like it’s not as much a sexter’s hangout as the media might
want you to
think</a>.</p>

<p>My circle of friends use it basically as an extension of weird Twitter – most
snaps I send and receive are strange angles of weird objects; the completely
mundane but somehow therapeutic (7 seconds of the camera pointed outside the
window of a tram, pointed at the ground moving below); or just closeups of
<a href="https://www.google.com.au/search?q=curtis+stone">Curtis Stone’s face</a>,
wherever we see him.</p>

<p><img style="border: 1px solid #000; margin: 0px auto; display: block;" title="Curtis Stone. Ugh." src="/assets/post-img/stone.jpg" /></p>

<p><a id="more"></a>Of course, the promise that they won’t get retained is just that: a promise.
Since your phone receives this image and shows it to you at some point, it must
be downloaded by your phone.  If it can be downladed by the phone, it can be
downloaded by something else.  We decided to find out how.</p>

<!--more-->

<hr />

<p>My first thought was to use
<a href="http://en.wikipedia.org/wiki/Cain_and_Abel_%28software%29">Cain</a> to re-route
the phone’s traffic to Snapchat via a computer with ARP poisoning, then
Wireshark to packet-sniff.  For whatever reason, we weren’t able to make this
work; while we did see some of the traffic (the non-HTTPS stuff), HTTPS
wouldn’t seem to pass through my friend’s computer.</p>

<p>Another got to work using a different set of tools on a Linux machine to do ARP
stuff, and I took a more direct route.</p>

<p>First, I set my phone’s proxy on WiFi to point to my machine.  Then I just
listened with netcat.  After receiving lots of apparently unrelated requests
(and the aforementioned HTTP requests<sup id="fnref:flurry" role="doc-noteref"><a href="#fn:flurry" class="footnote" rel="footnote">1</a></sup>), I found that Snapchat was
requesting an SSL forward:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ nc -l -p 5588
CONNECT feelinsonice.appspot.com:443 HTTP/1.1
Host: feelinsonice.appspot.com
</code></pre></div></div>

<p>“feelinsonice”.  Snapchat are hosted on GAE!</p>

<p>Having confirmed confirmed that this is a worthwhile approach, I wrote a little
Ruby to receive requests and start coaxing data from Snapchat.  The first
iteration was something like this:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1">#!/usr/bin/env ruby</span>

<span class="nb">require</span> <span class="s1">'openssl'</span>
<span class="nb">require</span> <span class="s1">'socket'</span>

<span class="n">l</span> <span class="o">=</span> <span class="no">TCPServer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">5588</span><span class="p">)</span>
<span class="n">l</span><span class="p">.</span><span class="nf">listen</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="k">while</span> <span class="kp">true</span>
  <span class="n">s</span> <span class="o">=</span> <span class="n">l</span><span class="p">.</span><span class="nf">accept</span>

  <span class="n">d</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="nf">readpartial</span><span class="p">(</span><span class="mi">8192</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">d</span> <span class="o">!~</span> <span class="sr">/CONNECT feelinsonice.appspot.com:443/</span>
    <span class="no">STDERR</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"rejecting unwanted client </span><span class="si">#{</span><span class="n">d</span><span class="p">.</span><span class="nf">inspect</span><span class="si">}</span><span class="s2">"</span>
    <span class="n">s</span><span class="p">.</span><span class="nf">close</span>
    <span class="k">next</span>
  <span class="k">end</span>

  <span class="no">STDERR</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"probably good client </span><span class="si">#{</span><span class="n">d</span><span class="p">.</span><span class="nf">inspect</span><span class="si">}</span><span class="s2">"</span>

  <span class="n">ctx</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">SSL</span><span class="o">::</span><span class="no">SSLContext</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"SSLv23_server"</span><span class="p">)</span>
  <span class="n">ctx</span><span class="p">.</span><span class="nf">cert</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">X509</span><span class="o">::</span><span class="no">Certificate</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="s2">"server.crt"</span><span class="p">))</span>
  <span class="n">ctx</span><span class="p">.</span><span class="nf">key</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">PKey</span><span class="o">::</span><span class="no">RSA</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="s2">"server.key"</span><span class="p">))</span>
  <span class="n">ctx</span><span class="p">.</span><span class="nf">verify_mode</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">SSL</span><span class="o">::</span><span class="no">VERIFY_NONE</span>

  <span class="n">s</span><span class="p">.</span><span class="nf">write</span> <span class="s2">"HTTP/1.1 200 OK</span><span class="se">\r\n\r\n</span><span class="s2">"</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">flush</span>

  <span class="n">ss</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">SSL</span><span class="o">::</span><span class="no">SSLSocket</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
  <span class="n">ss</span><span class="p">.</span><span class="nf">accept</span>

  <span class="no">STDERR</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"I THINK WE'RE IN, JOHN."</span>

  <span class="n">d</span> <span class="o">=</span> <span class="n">ss</span><span class="p">.</span><span class="nf">readpartial</span><span class="p">(</span><span class="mi">8192</span><span class="p">)</span>
  <span class="no">STDERR</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"got data: </span><span class="si">#{</span><span class="n">d</span><span class="p">.</span><span class="nf">inspect</span><span class="si">}</span><span class="s2">"</span>

  <span class="n">ss</span><span class="p">.</span><span class="nf">close</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">close</span>
<span class="k">end</span></code></pre></figure>

<p>To go with, I generated <code class="language-plaintext highlighter-rouge">server.crt</code> and <code class="language-plaintext highlighter-rouge">server.key</code> with CN <code class="language-plaintext highlighter-rouge">*.appspot.com</code>,
wondering if Snapchat are checking for a valid cert or not.</p>

<p>Turns out they are: I was getting <code class="language-plaintext highlighter-rouge">EOFError</code> thrown at the last <code class="language-plaintext highlighter-rouge">readpartial</code>
call, so presumably that was Snapchat not liking my identity.</p>

<p>Thankfully, the workaround wasn’t hard: make a local CA, install its
certificate on the phone, re-generate the SSL certificate with that
CA<sup id="fnref:ssl-ca" role="doc-noteref"><a href="#fn:ssl-ca" class="footnote" rel="footnote">2</a></sup>, and away we go!</p>

<p>Next, capture the data from the phone, and establish the connection to Snapchat
ourselves to complete this man-in-the-middle. We put this after reading the
first block of data from the client above:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># make the real connection</span>
<span class="k">begin</span>
  <span class="n">up</span> <span class="o">=</span> <span class="no">TCPSocket</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'feelinsonice.appspot.com'</span><span class="p">,</span> <span class="mi">443</span><span class="p">)</span>
<span class="k">rescue</span> <span class="no">Errno</span><span class="o">::</span><span class="no">ECONNREFUSED</span>
  <span class="no">STDERR</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"snapchat getting weary?"</span>
  <span class="n">ss</span><span class="p">.</span><span class="nf">close</span> <span class="k">rescue</span> <span class="kp">false</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">close</span> <span class="k">rescue</span> <span class="kp">false</span>
  <span class="k">next</span>
<span class="k">end</span>

<span class="n">ups</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">SSL</span><span class="o">::</span><span class="no">SSLSocket</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">up</span><span class="p">.</span><span class="nf">to_io</span><span class="p">)</span>
<span class="n">ups</span><span class="p">.</span><span class="nf">connect</span>

<span class="n">ups</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
<span class="no">STDERR</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"forwarded request from phone"</span>

<span class="k">while</span> <span class="kp">true</span>
  <span class="k">begin</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">ups</span><span class="p">.</span><span class="nf">readpartial</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
  <span class="k">rescue</span> <span class="no">EOFError</span>
    <span class="no">STDERR</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"no more"</span>
    <span class="n">ss</span><span class="p">.</span><span class="nf">close</span>
    <span class="n">s</span><span class="p">.</span><span class="nf">close</span>
    <span class="k">break</span>
  <span class="k">end</span>
  <span class="no">STDERR</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"they say: </span><span class="si">#{</span><span class="n">r</span><span class="p">.</span><span class="nf">inspect</span><span class="si">}</span><span class="s2">"</span>

  <span class="c1"># send back to phone</span>
  <span class="n">ss</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
  
  <span class="no">STDERR</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"written back"</span>

  <span class="k">break</span> <span class="k">if</span> <span class="n">r</span><span class="p">.</span><span class="nf">length</span><span class="p">.</span><span class="nf">zero?</span>
<span class="k">end</span>

<span class="no">STDERR</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"quiet"</span></code></pre></figure>

<p>We open a regular SSL socket to Snapchat’s GAE server, forward the request from
the phone, and read back what Snapchat said.</p>

<p>It turns out this is enough to start getting sensitive data in a form where we
can attack it offline<sup id="fnref:http" role="doc-noteref"><a href="#fn:http" class="footnote" rel="footnote">3</a></sup>.</p>

<p>Add some logging of responses to file; you’ll see a request to <code class="language-plaintext highlighter-rouge">/ph/sync</code>,
followed by a bulk of data indicating who our friends are, and information
regarding new snaps.  Then, the phone will try to fetch those snaps: you’ll see
requests to <code class="language-plaintext highlighter-rouge">/ph/blob</code>, like:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/ph/blob?id=...&amp;username=hellomoto&amp;timestamp=1368171438418&amp;req_token=...
</code></pre></div></div>

<p>It turns out all the data required is in the URI; no funny header business.
You can paste the requested URL directly into a browser and fetch the blob.</p>

<p>What you get is identified by the BSD file tool as <code class="language-plaintext highlighter-rouge">data</code> – not obviously an
image, video, or whatever, nor any headers indicating encryption or
compression.</p>

<p>First, I had a look at the size: 19,712 bytes, which is divisible by 256.  This
feels like too much of a coincidence; I’d be surprised by divisibility by
anything above 4 or 8.  My going assumption is that images are transferred in
JPEG, and ~half the JPEGs I looked at on my disk have odd numbers of bytes, so
I’m guessing there’s nothing frame-y about JPEG that would cause the plaintext
to be in a regular block of bytes – so conclusion, it’s probably a block
cipher.</p>

<p>Next, it was time to see if there were any obvious cryptographic errors.  A
repeated block in the ciphertext might give us a hint about the encryption
mode.</p>

<p>Sure enough, a repeated 16-byte block:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="o">&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="s1">'x'</span><span class="p">,</span> <span class="s1">'r:ASCII-8BIT'</span><span class="p">).</span><span class="nf">read</span><span class="p">;</span> <span class="kp">nil</span>
<span class="o">=&gt;</span> <span class="kp">nil</span>
<span class="o">&gt;</span> <span class="n">data</span><span class="p">.</span><span class="nf">bytes</span><span class="p">.</span><span class="nf">each_slice</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="nf">to_a</span><span class="p">.</span><span class="nf">length</span>
<span class="o">=&gt;</span> <span class="mi">1232</span>
<span class="o">&gt;</span> <span class="n">data</span><span class="p">.</span><span class="nf">bytes</span><span class="p">.</span><span class="nf">each_slice</span><span class="p">(</span><span class="mi">8</span><span class="p">).</span><span class="nf">to_a</span><span class="p">.</span><span class="nf">length</span>
<span class="o">=&gt;</span> <span class="mi">2464</span>
<span class="o">&gt;</span> <span class="n">data</span><span class="p">.</span><span class="nf">bytes</span><span class="p">.</span><span class="nf">each_slice</span><span class="p">(</span><span class="mi">8</span><span class="p">).</span><span class="nf">to_a</span><span class="p">.</span><span class="nf">uniq</span><span class="p">.</span><span class="nf">length</span>
<span class="o">=&gt;</span> <span class="mi">2462</span>
<span class="o">&gt;</span> <span class="n">data</span><span class="p">.</span><span class="nf">bytes</span><span class="p">.</span><span class="nf">each_slice</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="nf">to_a</span><span class="p">.</span><span class="nf">length</span>
<span class="o">=&gt;</span> <span class="mi">1232</span>
<span class="o">&gt;</span> <span class="n">data</span><span class="p">.</span><span class="nf">bytes</span><span class="p">.</span><span class="nf">each_slice</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="nf">to_a</span><span class="p">.</span><span class="nf">uniq</span><span class="p">.</span><span class="nf">length</span>
<span class="o">=&gt;</span> <span class="mi">1231</span>
<span class="o">&gt;</span></code></pre></figure>

<p>So apparently a 16-byte (128-bit) block cipher, in <a href="http://en.wikipedia.org/wiki/Block_cipher_mode_of_operation#Electronic_codebook_.28ECB.29">ECB
mode</a>
at that.  (Not a good thing.)   Seeing as there wasn’t a demonstration of a lot
of intelligence this far, I started to wonder if it wasn’t just XORed, as it’d
look the same.</p>

<p>A <a href="https://twitter.com/kyhwana/status/332770066150068227">friend on Twitter
noted</a> that the repeated
block was at the same location as JPEG files have a string of repeated bytes.</p>

<p>Here’s a JPEG surrounding the repeated bytes:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>00000a0: 090c 0b0c 180d 0d18 3221 1c21 3232 3232  ........2!.!2222
00000b0: 3232 3232 3232 3232 3232 3232 3232 3232  2222222222222222
00000c0: 3232 3232 3232 3232 3232 3232 3232 3232  2222222222222222
00000d0: 3232 3232 3232 3232 3232 3232 3232 ffc0  22222222222222..
</code></pre></div></div>

<p>Here’s the ciphertext around the repeated 16-byte blocks:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0000060: 61e0 3cb3 ca5d 4ebe 4cd9 2212 3e9a 40ba  a.&lt;..]N.L.".&gt;.@.
0000070: 39e4 8dc2 ac39 8f10 59d8 fc08 9d19 b239  9....9..Y......9
0000080: 39e4 8dc2 ac39 8f10 59d8 fc08 9d19 b239  9....9..Y......9
0000090: 4614 4d69 7c61 5d11 cabb 5310 1697 5b4f  F.Mi|a]...S...[O
</code></pre></div></div>

<p>Note that the <code class="language-plaintext highlighter-rouge">32</code> bytes are more than 2x 16-byte blocks in length: they extend
well before and after the 16-byte alignment.  But the ciphertext doesn’t show
that at all: this rules out a plain repeating XOR, as we’d otherwise expect to
see something more like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0000060: 61e0 3cb3 ca5d 4ebe 4cd9 2212 9d19 b239  a.&lt;..]N.L."....9
0000070: 39e4 8dc2 ac39 8f10 59d8 fc08 9d19 b239  9....9..Y......9
0000080: 39e4 8dc2 ac39 8f10 59d8 fc08 9d19 b239  9....9..Y......9
0000090: 39e4 8dc2 ac39 8f10 59d8 fc08 9d19 5b4f  9....9..Y.....[O
</code></pre></div></div>

<p>… assuming the <code class="language-plaintext highlighter-rouge">32</code> bytes above are exactly the number you’d expect to find
anywhere, which isn’t the case; but you get the point: there’d be some, but
there are none.  The key and data are totally mixed, which suggests a real
block cipher.</p>

<p>Since there aren’t really good ways to attack this directly (at least, not for
me, an utter novice), it seemed much faster just look for the cipher/key/etc.
in the source.</p>

<p>I was thinking I’d have to do some MitM of Google Play or root my Android, but
it turns out Googling ‘snapchat apk download’ is enough. Hah.</p>

<p>The first tool I found for getting the contents and decompiling the APK was
<a href="http://code.google.com/p/android-apktool/">android-apktool</a>; there are surely
better tools (this gives you smali output, not Java or Java-ish), but it was
easy enough to peruse, given I just wanted to know what the key was and what
primitives were being used.</p>

<p>The code was totally unobfuscated, so it wasn’t hard to find the
<code class="language-plaintext highlighter-rouge">com.snapchat.android.api.SnapchatServer</code>: the <code class="language-plaintext highlighter-rouge">.smali</code> file is a bit weird to
read, but sure enough there’s:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.field private static final BASE_URL:Ljava/lang/String; =
        "https://feelinsonice.appspot.com"
</code></pre></div></div>

<p>and:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.line 247
.local v2, image:[B
sget-object v6, Lcom/snapchat/android/util/AESEncrypt;-&gt;ENCRYPT_KEY_2:Ljava/lang/String;

invoke-static {v2, v6},
        Lcom/snapchat/android/util/AESEncrypt;-&gt;encrypt([BLjava/lang/String;)[B

move-result-object v0

.line 248
.local v0, encryptedImage:[B
</code></pre></div></div>

<p>I guess that’d be like:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// byte[] image;</span>
<span class="kt">byte</span><span class="o">[]</span> <span class="n">encryptedImage</span> <span class="o">=</span> <span class="nc">AESEncrypt</span><span class="o">.</span><span class="na">encrypt</span><span class="o">(</span><span class="n">image</span><span class="o">,</span> <span class="nc">AESEncrypt</span><span class="o">.</span><span class="na">ENCRYPT_KEY_2</span><span class="o">);</span></code></pre></figure>

<p>or something.  I don’t actually do Java, so maybe that’s all backwards, but the
point seems pretty clear.  It occurs to me I’m reading the encryption code, but
while there are two keys, only ENCRYPT_KEY_2 is ever used.</p>

<p>So, what encryption is going on?  <code class="language-plaintext highlighter-rouge">AESEncrypt.smali</code> reads:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.line 8
const-string v0, "1234567891123456"

sput-object v0, Lcom/snapchat/android/util/AESEncrypt;-&gt;ENCRYPT_KEY:Ljava/lang/String;

.line 9
const-string v0, "M02cnQ51Ji97vwT4"

sput-object v0, Lcom/snapchat/android/util/AESEncrypt;-&gt;ENCRYPT_KEY_2:Ljava/lang/S
</code></pre></div></div>

<p>Here are the keys!  Is it really as simple as 128-bit AES in ECB mode?</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.line 21
const-string v3, "AES/ECB/PKCS5Padding"
</code></pre></div></div>

<p>Looks like it.  Note the padding scheme; seems weird to use PKCS#5 which has
apparently “only been defined for block ciphers that use 64 bit (8 byte) block
size”, when the size here is 128-bit.  Let’s give it a go.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="o">&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="s1">'x'</span><span class="p">,</span> <span class="s1">'r:ASCII-8BIT'</span><span class="p">).</span><span class="nf">read</span><span class="p">;</span> <span class="kp">nil</span>
<span class="o">=&gt;</span> <span class="kp">nil</span>
<span class="o">&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">Cipher</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'AES-128-ECB'</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;OpenSSL::Cipher:0x007f8182658618&gt;</span>
<span class="o">&gt;</span> <span class="n">c</span><span class="p">.</span><span class="nf">decrypt</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;OpenSSL::Cipher:0x007f8182658618&gt;</span>
<span class="o">&gt;</span> <span class="n">c</span><span class="p">.</span><span class="nf">key</span> <span class="o">=</span> <span class="s1">'M02cnQ51Ji97vwT4'</span>
<span class="o">=&gt;</span> <span class="s2">"M02cnQ51Ji97vwT4"</span>
<span class="o">&gt;</span> <span class="n">o</span> <span class="o">=</span> <span class="s1">''</span><span class="p">.</span><span class="nf">force_encoding</span><span class="p">(</span><span class="s1">'ASCII-8BIT'</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="s2">""</span>
<span class="o">&gt;</span> <span class="n">data</span><span class="p">.</span><span class="nf">bytes</span><span class="p">.</span><span class="nf">each_slice</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="p">{</span><span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">o</span> <span class="o">+=</span> <span class="n">c</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:chr</span><span class="p">).</span><span class="nf">join</span><span class="p">)}</span>
<span class="o">=&gt;</span> <span class="kp">nil</span>
<span class="o">&gt;</span> <span class="n">o</span> <span class="o">+=</span> <span class="n">c</span><span class="p">.</span><span class="nf">final</span><span class="p">;</span> <span class="kp">nil</span>
<span class="o">=&gt;</span> <span class="kp">nil</span>
<span class="o">&gt;</span> <span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="o">...</span><span class="mi">60</span><span class="p">]</span>
<span class="o">=&gt;</span> <span class="s2">"</span><span class="se">\xFF\xD8\xFF\xE0\0\x10</span><span class="s2">JFIF</span><span class="se">\0\x01\x01\0\0\x01\0\x01\0\0\xFF\xDB\0</span><span class="s2">C</span><span class="se">\0\x14\x0E</span><span class="s2">\
x0F</span><span class="se">\x12\x0F\r\x14\x12\x10\x12\x17\x15\x14\x18\x1E</span><span class="s2">2!</span><span class="se">\x1E\x1C\x1C\x1E</span><span class="s2">=,.$2I@LKG@FE
PZ"</span>
<span class="o">&gt;</span></code></pre></figure>

<p>JFIF! Hello! We got our man.</p>

<p><img style="border: 1px solid #000; margin: 0px auto; display: block;" title="Thanks, @lapscallion." src="/assets/post-img/snapchat.jpg" /></p>

<p>That’s as far as I got; it was at this stage that I thought of Googling the
encryption key, to see if anyone else had tried this.
<a href="http://adamcaudill.com/2012/12/31/revisiting-snapchat-api-and-security/">Seems</a>
<a href="https://github.com/tlack/snaphax">they</a>
<a href="https://gist.github.com/NeilHanlon/4686779">had</a>.  Still, I’m glad it wasn’t
until here that I searched.</p>

<p>Many thanks to the <a href="http://www.matasano.com/articles/crypto-challenges/">Matasano crypto
challenges</a> – some of the
above came from knowledge picked up doing them.</p>

<p>The conclusion is that it’s easy to intercept and decrypt the data Snapchat on
your phone receives; it’d be one, maybe two hours of work to turn the above
code into something I could just switch on and forget about, while it happily
archives every Snapchat I ever receive.</p>

<p>Truth be told, I can’t be bothered – it’s fun, and I don’t want to ruin the
unique feeling it has by virtue of being an ephemeral medium – but don’t think
it’s hard for someone who cared enough to.</p>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:flurry" role="doc-endnote">
      <p>To <a href="http://www.flurry.com/">Flurry</a>, a mobile analytics company, containing data like my phone model, screen res, probably some unique ID … <a href="#fnref:flurry" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:ssl-ca" role="doc-endnote">
      <p>I used <a href="http://www.freebsdmadeeasy.com/tutorials/freebsd/create-a-ca-with-openssl.php">this guide</a>, but there are better ones out there which are probably more explanatory. <a href="#fnref:ssl-ca" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:http" role="doc-endnote">
      <p>Note that this client doesn’t speak HTTP; accordingly, it doesn’t know when to close the connection (GAE’s HTTP server sends the responses with <code class="language-plaintext highlighter-rouge">Content-Length</code>, so we should parse that and know when we’ve received all the data, but it’s easier just to restart the server over and over at this stage). <a href="#fnref:http" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

</article>


<aside class="related">
  <h3>Related posts</h3>
  <ul class="related-posts">
    
      <li>
        <a href="/cryptography/2016/02/20/breaking-homegrown-crypto/">
          Breaking homegrown crypto
          <small><time datetime="2016-02-20T02:56:00+02:00">20 Feb 2016</time></small>
        </a>
      </li>
    
      <li>
        <a href="/2012/04/18/escapology/">
          Escapology: how, when and why to encode and escape
          <small><time datetime="2012-04-18T14:10:00+03:00">18 Apr 2012</time></small>
        </a>
      </li>
    
      <li>
        <a href="/2021/02/28/loader/">
          Knowing when to look past your code
          <small><time datetime="2021-02-28T00:00:00+02:00">28 Feb 2021</time></small>
        </a>
      </li>
    
  </ul>
</aside>


      </main>

      <footer class="footer">
        <a href="/archive/">Archived blog</a>
        <small>Xx</small>
      </footer>
    </div>
  </body>
</html>
