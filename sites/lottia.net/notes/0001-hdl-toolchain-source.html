<!DOCTYPE html><html lang="en"><head>
    
    
    <meta charset="utf-8">
    
      <title>Installing an HDL toolchain from source - lottia notes</title>
      <meta property="og:title" content="Installing an HDL toolchain from source">
      <meta property="og:site_name" content="lottia notes">
      <meta property="og:description" content="A fairly detailed guide on building and installing a gateware toolchain in a self-contained and repeatable way.">
    
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="website">

    <meta name="author" content="Asherah Connor">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="stylesheet.css?v=1">
    <link rel="stylesheet" href="syntax.css">

    
      <link href="atom.xml" rel="alternate" title="lottia notes" type="application/atom+xml">
    
    <meta name="generator" content="Nanoc 4.12.16">
    <link rel="icon" type="image/png" href="lotte.png">
  </head>
  <body id="top">
    <div class="flex">
      <main>
        <h1>Installing an HDL toolchain from source</h1>
        
          <p>
            <span class="created-at">2023-06-27</span>
            
          </p>
        
        <section id="opening">
<p>It occurred to me while writing up <a href="https://github.com/charlottia/sh1107/tree/aeb1c3f77d3226760755331624dd7920779cc2b7#requirements">¬ß Requirements</a> in the README
for some<sup class="footnote-ref"><a href="#fn-baby" id="fnref-baby" data-footnote-ref="">1</a></sup> gateware that getting the whole beginner‚Äôs open-source FPGA
toolchain set up can be a serious stumbling block, as I imagine it probably was
for me once.</p>
<p>The main pre-packaged solution that comes to mind is <a href="https://github.com/YosysHQ/oss-cad-suite-build">OSS CAD Suite</a>. It‚Äôs
excellent, but common to ‚Äúall-in-one‚Äù solutions, it makes assumptions that mean
it‚Äôs prone to inflexibility in certain ways. Rebuilding just one of the tools is
not always as simple as that ‚Äî Python environment or shared library conflicts
can result, and the tools are wrapped so as to always prefer their own
distribution, necessitating further hacks for those that call each other.</p>
<p>With any luck, you won‚Äôt run into any of these cases, but if you do, getting
everything built for yourself correctly can be a bit vexing ‚Äî the YosysHQ tools‚Äô
documentation tends to point back to their own pre-built packages (and products)
in preference to (and sometimes instead of) instructing on how to build.</p>
<p>I‚Äôve done this process three times recently while rejigging my development
environments, so I‚Äôm describing it for posterity/others.</p>
</section>
<section id="scope">
<h2>Scope <a href="#scope" aria-hidden="true" title="Permalink to section" class="anchor">üîó</a></h2>
<p>By the end of this guide, you‚Äôll have the following ready to go:</p>
<ul>
<li><a href="https://git-scm.com/">Git</a></li>
<li><a href="https://www.python.org">Python 3</a></li>
<li><a href="https://amaranth-lang.org/docs/amaranth/latest/intro.html">Amaranth</a></li>
<li><a href="https://yosyshq.net/yosys/">Yosys</a></li>
<li>
<a href="https://github.com/YosysHQ/nextpnr">nextpnr</a> with <a href="https://github.com/YosysHQ/icestorm">Project IceStorm</a>
</li>
<li>
<a href="https://github.com/YosysHQ/sby">SymbiYosys</a> and <a href="https://github.com/Z3Prover/z3">Z3</a>
</li>
</ul>
<p><a href="https://git-scm.com/">Git</a> is for acquiring source code.</p>
<p><a href="https://www.python.org">Python 3</a> is for using Amaranth.</p>
<p><a href="https://amaranth-lang.org/docs/amaranth/latest/intro.html">Amaranth</a> is the <a href="https://en.wikipedia.org/wiki/Hardware_description_language">HDL</a> I‚Äôm using. It is a Python library which consists of a
language for describing digital logic, as well as facilitating simulation and
building of the resulting designs. It integrates well with the ecosystem, and
permits intermixing with <a href="https://en.wikipedia.org/wiki/Verilog">Verilog</a> (or <a href="https://en.wikipedia.org/wiki/VHDL">VHDL</a>). At time of writing, its
development pace has quickened.</p>
<p><a href="https://yosyshq.net/yosys/">Yosys</a> is the synthesis framework at the heart of Amaranth. It is a digital
logic synthesizer, which is a phrasing that severely understates how much work
is involved‚Äîfor more information, see the <a href="https://yosys.readthedocs.io/_/downloads/en/latest/pdf/">Yosys manual</a>.</p>
<p>Amaranth actually comes with its own <a href="https://pypi.org/project/amaranth-yosys/">portable Yosys</a> built-in, which works
beautifully. We‚Äôll use it, but we‚Äôll build it separately, too: for cases when we
want to make our own changes, or use step-through debugging to understand what‚Äôs
happening. It‚Äôs also necessary for formal verification.</p>
<p><a href="https://github.com/YosysHQ/nextpnr">nextpnr</a> and <a href="https://github.com/YosysHQ/icestorm">Project IceStorm</a> are for targeting the Lattice <a href="https://en.wikipedia.org/wiki/ICE_(FPGA)#iCE40_(40_nm)">iCE40</a> family
of FPGAs, which is known for its relative accessibility. I‚Äôve been learning with
an <a href="https://1bitsquared.com/products/icebreaker">iCEBreaker</a> (<a href="https://www.crowdsupply.com/1bitsquared/icebreaker-fpga">see also</a>), which is built around
the iCE40UP5k FPGA, and have found this to be true.</p>
<p><a href="https://github.com/YosysHQ/sby">SymbiYosys</a> and <a href="https://github.com/Z3Prover/z3">Z3</a> are for <a href="https://en.wikipedia.org/wiki/Formal_verification">formal verification</a>. I promise it‚Äôs good.</p>
<p>Instructions are verified for Linux <code>x86_64</code> and macOS <code>arm64</code>. I intended to
cover Windows, too, but over four months found the experience
inconsistent<sup class="footnote-ref"><a href="#fn-windows" id="fnref-windows" data-footnote-ref="">2</a></sup> enough that it was easier to use WSL 2<sup class="footnote-ref"><a href="#fn-wsl" id="fnref-wsl" data-footnote-ref="">3</a></sup>. On Linux
and WSL, I‚Äôve used Debian.</p>
<p>I assume Linux users can install packages using the distribution package
manager, and macOS users using <a href="https://brew.sh/">Homebrew</a>. I‚Äôm going to avoid installing almost
anything globally, however, that wouldn‚Äôt already get installed by your package
manager as a matter of course, especially when there‚Äôs reasons you might need
multiple versions around.</p>
</section>
<section id="git">
<h2>Git <a href="#git" aria-hidden="true" title="Permalink to section" class="anchor">üîó</a> <a href="#scope" aria-hidden="true" title="Back to scope" class="anchor">‚Ü©</a></h2>
<p>The <a href="https://git-scm.com/">Git</a> website‚Äôs <a href="https://git-scm.com/downloads">Downloads</a> page has instructions for
acquiring it through your relevant package manager.</p>
</section>
<section id="python-3">
<h2>Python 3 <a href="#python-3" aria-hidden="true" title="Permalink to section" class="anchor">üîó</a> <a href="#scope" aria-hidden="true" title="Back to scope" class="anchor">‚Ü©</a></h2>
<p>That was easy. Now the opinions start.</p>
<p>Install the <a href="https://asdf-vm.com/"><code>asdf</code> Multiple Version Runtime Manager</a>. The <a href="https://asdf-vm.com/guide/getting-started.html">Getting
Started</a> page has commands for dependency installation
through package manager. Use the official <code>git</code> method to download <code>asdf</code>
itself, and then follow the instructions for your shell.</p>
<p>Now install the Python <code>asdf</code> plugin, and install the latest stable version of
Python:</p>
<pre><code class="language-console?prompt=$"><span class="gp">~ $</span><span class="w"> </span>asdf plugin add python
<span class="go">initializing plugin repository...Cloning into '/home/charlotte/.asdf/repository'...
remote: Enumerating objects: 5273, done.
remote: Counting objects: 100% (481/481), done.
remote: Compressing objects: 100% (88/88), done.
remote: Total 5273 (delta 419), reused 445 (delta 393), pack-reused 4792
Receiving objects: 100% (5273/5273), 1.21 MiB | 29.47 MiB/s, done.
Resolving deltas: 100% (2849/2849), done.
</span><span class="gp">~ $</span><span class="w"> </span>asdf latest python
<span class="go">3.11.4
</span><span class="gp">~ $</span><span class="w"> </span>asdf <span class="nb">install </span>python 3.11.4
<span class="go">python-build 3.11.4 /home/charlotte/.asdf/installs/python/3.11.4
Downloading Python-3.11.4.tar.xz...
-&gt; https://www.python.org/ftp/python/3.11.4/Python-3.11.4.tar.xz
Installing Python-3.11.4...
Installed Python-3.11.4 to /home/charlotte/.asdf/installs/python/3.11.4
</span><span class="gp">~ $</span><span class="w"> </span>asdf global python 3.11.4
<span class="gp">~ $</span></code></pre>
<p>(You might get some warnings about extensions not being compiled. That‚Äôs OK.
There‚Äôs also 3.12.0b3 available at time of writing, if you don‚Äôt mind a beta.)</p>
<p>The last command makes it the default Python for our user. <code>asdf</code> puts some
shims in our <code>PATH</code> which use a combination of our configured defaults
(<code>global</code>), our current path (<code>local</code>), and environment variables (<code>shell</code>) to
select the desired version:</p>
<pre><code class="language-console?prompt=$,>>>"><span class="gp">~ $</span><span class="w"> </span>which python
<span class="go">/home/charlotte/.asdf/shims/python
</span><span class="gp">~ $</span><span class="w"> </span>asdf current python
<span class="go">python          3.11.4          /home/charlotte/.tool-versions
</span><span class="gp">~ $</span><span class="w"> </span>asdf where python
<span class="go">/home/charlotte/.asdf/installs/python/3.11.4
</span><span class="gp">~ $</span><span class="w"> </span>asdf which python
<span class="go">/home/charlotte/.asdf/installs/python/3.11.4/bin/python
</span><span class="gp">~ $</span><span class="w"> </span>python
<span class="go">Python 3.11.4 (main, Jun 26 2023, 16:06:57) [GCC 10.2.1 20210110] on linux
Type "help", "copyright", "credits" or "license" for more information.
</span><span class="gp">&gt;&gt;&gt;</span></code></pre>
</section>
<section id="venv">
<h3>venv <a href="#venv" aria-hidden="true" title="Permalink to section" class="anchor">üîó</a> <a href="#scope" aria-hidden="true" title="Back to scope" class="anchor">‚Ü©</a></h3>
<p>The last thing we want to do is actually a per-project step. We‚Äôre about to
install Amaranth, which is a Python dependency, and so we want to make sure
we‚Äôre installing Python dependencies in a separate <a href="https://docs.python.org/3/library/venv.html">virtual environment</a> per
project, that they don‚Äôt interfere or conflict with each other.</p>
<p>In your project directory, create a new virtual environment called <code>venv</code>, and
then activate it:</p>
<pre><code class="language-console"><span class="gp">prj $</span><span class="w"> </span>python <span class="nt">-m</span> venv venv
<span class="gp">prj $</span><span class="w"> </span><span class="nb">source </span>venv/bin/activate
<span class="gp">(venv) prj $</span></code></pre>
<p>(Note there are a few different <code>activate</code> variants in the <code>bin</code> directory for
different shells.)</p>
<p>Add <code>venv</code> to your <code>.gitignore</code> or similar.</p>
<p>It‚Äôs important to remember to activate the virtual environment before running
Python or installing dependencies with <code>pip</code>. Many IDEs will automatically
activate (or prompt to activate) virtual environments when they‚Äôre detected in
the root of a project. Similarly, some shells can be configured to do similar.</p>
<p>Note that the Python instance used by the virtual environment is tied to the
specific version we had chosen through <code>asdf</code>, and not the shim:</p>
<pre><code class="language-console"><span class="gp">(venv) prj $</span><span class="w"> </span><span class="nb">readlink </span>venv/bin/python
<span class="go">/home/charlotte/.asdf/installs/python/3.11.4/bin/python
</span><span class="gp">(venv) prj $</span></code></pre>
<p>We‚Äôre ready to install Python dependencies.</p>
</section>
<section id="amaranth">
<h2>Amaranth <a href="#amaranth" aria-hidden="true" title="Permalink to section" class="anchor">üîó</a> <a href="#scope" aria-hidden="true" title="Back to scope" class="anchor">‚Ü©</a></h2>
<p>Firstly, note Amaranth‚Äôs own <a href="https://amaranth-lang.org/docs/amaranth/latest/install.html">installation instructions</a>. We‚Äôll follow along, and deviate from them somewhat.</p>
<p>Install GTKWave from your package manager. We‚Äôll come back to Yosys.</p>
<p>Verify we do in fact have the latest <code>pip</code>:</p>
<pre><code class="language-console"><span class="gp">(venv) prj $</span><span class="w"> </span>pip <span class="nb">install</span> <span class="nt">--upgrade</span> pip
<span class="go">Requirement already satisfied: pip in ./venv/lib/python3.11/site-packages (23.1.2)
</span><span class="gp">(venv) prj $</span></code></pre>
<p>We do not pass <code>--user</code> to <code>pip</code>‚Äîit is rejected in a virtual environment, for
<code>--user</code> implies writing to your home directory, which would escape the virtual
environment.</p>
<p>We‚Äôre going to skip the latest release and go straight to an editable
development snapshot. You may want to clone it within your project directory,
perhaps as a Git submodule, or along-side. I‚Äôm going with along-side.</p>
<p>Clone Amaranth and install it in editable mode, with the built-in Yosys:</p>
<pre><code class="language-console"><span class="gp">(venv) prj $</span><span class="w"> </span><span class="nb">cd</span> ..
<span class="gp">(venv) ~ $</span><span class="w"> </span>git clone https://github.com/amaranth-lang/amaranth
<span class="go">Cloning into 'amaranth'...
remote: Enumerating objects: 8651, done.
remote: Counting objects: 100% (272/272), done.
remote: Compressing objects: 100% (95/95), done.
remote: Total 8651 (delta 170), reused 227 (delta 162), pack-reused 8379
Receiving objects: 100% (8651/8651), 1.71 MiB | 29.14 MiB/s, done.
Resolving deltas: 100% (6474/6474), done.
</span><span class="gp">(venv) ~ $</span><span class="w"> </span><span class="nb">cd </span>amaranth
<span class="gp">(venv) amaranth $</span><span class="w"> </span>pip <span class="nb">install</span> <span class="nt">--editable</span> .[builtin-yosys]
<span class="go">Obtaining file:///home/charlotte/amaranth
  Installing build dependencies ... done
  Checking if build backend supports build_editable ... done
  Getting requirements to build editable ... done
  Preparing editable metadata (pyproject.toml) ... done

[... lots of output ...]

Successfully built amaranth
Installing collected packages: wasmtime, pyvcd, MarkupSafe, Jinja2, amaranth-yosys, amaranth
Successfully installed Jinja2-3.1.2 MarkupSafe-2.1.3 amaranth-0.4.dev134+g99417d6 amaranth-yosys-0.25.0.0.post72 pyvcd-0.4.0 wasmtime-9.0.0
</span><span class="gp">(venv) amaranth $</span></code></pre>
<p>Note that the virtual environment remained active even as we left the directory
we created it in. This is desirable: it means the editable snapshot was
installed in our virtual environment.</p>
<p>We‚Äôll install the <a href="https://github.com/amaranth-lang/amaranth-boards">board definitions</a> now, too. Clone the
repository and install it the same way, except without the <code>[builtin-yosys]</code>
option:</p>
<pre><code class="language-console"><span class="gp">(venv) amaranth $</span><span class="w"> </span><span class="nb">cd</span> ..
<span class="gp">(venv) ~ $</span><span class="w"> </span>git clone https://github.com/amaranth-lang/amaranth-boards
<span class="go">Cloning into 'amaranth-boards'...
remote: Enumerating objects: 1353, done.
remote: Counting objects: 100% (532/532), done.
remote: Compressing objects: 100% (136/136), done.
remote: Total 1353 (delta 426), reused 405 (delta 396), pack-reused 821
Receiving objects: 100% (1353/1353), 307.90 KiB | 17.11 MiB/s, done.
Resolving deltas: 100% (943/943), done.
</span><span class="gp">(venv) ~ $</span><span class="w"> </span><span class="nb">cd </span>amaranth-boards/
<span class="gp">(venv) amaranth-boards $</span><span class="w"> </span>pip <span class="nb">install</span> <span class="nt">--editable</span> <span class="nb">.</span>
<span class="go">Obtaining file:///home/charlotte/amaranth-boards
  Installing build dependencies ... done
  Checking if build backend supports build_editable ... done
  Getting requirements to build editable ... done
  Preparing editable metadata (pyproject.toml) ... done

[... lots of output ...]

Successfully built amaranth-boards
Installing collected packages: amaranth-boards
Successfully installed amaranth-boards-0.1.dev228+g54e6ac4
</span><span class="gp">(venv) amaranth-boards $</span></code></pre>
<p>We‚Äôre ready. We can verify the installations by using a Python shell in the
virtual environment:</p>
<pre><code class="language-console?prompt=$,>>>"><span class="gp">(venv) prj $</span><span class="w"> </span>python
<span class="go">Python 3.11.4 (main, Jun 26 2023, 16:06:57) [GCC 10.2.1 20210110] on linux
Type "help", "copyright", "credits" or "license" for more information.
</span><span class="gp">&gt;&gt;&gt;</span><span class="w"> </span>from amaranth import <span class="k">*</span>
<span class="gp">&gt;&gt;&gt;</span><span class="w"> </span>Signal
<span class="go">&lt;class 'amaranth.hdl.ast.Signal'&gt;
</span><span class="gp">&gt;&gt;&gt;</span><span class="w"> </span>from amaranth_boards.icebreaker import <span class="k">*</span>
<span class="gp">&gt;&gt;&gt;</span><span class="w"> </span>ICEBreakerPlatform
<span class="go">&lt;class 'amaranth_boards.icebreaker.ICEBreakerPlatform'&gt;
</span><span class="gp">&gt;&gt;&gt;</span></code></pre>
</section>
<section id="yosys">
<h2>Yosys <a href="#yosys" aria-hidden="true" title="Permalink to section" class="anchor">üîó</a> <a href="#scope" aria-hidden="true" title="Back to scope" class="anchor">‚Ü©</a></h2>
<p>Clone the <a href="https://github.com/yosyshq/yosys">Yosys repo</a> and read its README. <a href="https://github.com/yosyshq/yosys#building-from-source">¬ß Building from Source</a> tells you
which packages from the package manager it needs.</p>
<p>By default, Yosys will install into <code>/usr/local</code>, but we‚Äôll override it to use
<code>~/.local</code> instead. We do this by setting the <code>PREFIX</code> variable, and
importantly, we need it set for the build step too, not only install. Otherwise,
the <code>yosys-config</code> helper that gets installed will report the wrong values.</p>
<p>Yosys‚Äôs Makefile will include <code>Makefile.conf</code> if it exists; we‚Äôll put it in
there so we can‚Äôt forget, and don‚Äôt have to stash Makefile changes when we pull
the latest. Then we build in parallel and install:</p>
<pre><code class="language-console?prompt=%20yosys%20$"><span class="gp">(venv) yosys $</span><span class="w"> </span><span class="nb">echo</span> <span class="s1">'PREFIX = $(HOME)/.local'</span> <span class="o">&gt;</span> Makefile.conf
<span class="gp">(venv) yosys $</span><span class="w"> </span>make <span class="nt">-j8</span>
<span class="go">[Makefile.conf] PREFIX = $(HOME)/.local
[  0%] Building kernel/version_2310a0ea9.cc
[  0%] Building kernel/driver.o
[  0%] Building techlibs/common/simlib_help.inc
[  0%] Building techlibs/common/simcells_help.inc
[  1%] Building kernel/rtlil.o

[... lots of output ...]

[ 94%] ABC: `` Compiling: /src/bdd/llb/llb4Nonlin.c
[ 94%] ABC: `` Compiling: /src/bdd/llb/llb4Sweep.c
[ 94%] ABC: `` Building binary: abc-1de4eaf
[100%] Building yosys-abc

  Build successful.

</span><span class="gp">(venv) yosys $</span><span class="w"> </span>make <span class="nb">install</span>
<span class="go">[Makefile.conf] PREFIX = $(HOME)/.local
mkdir -p /home/charlotte/.local/bin
cp yosys yosys-config yosys-abc yosys-filterlib yosys-smtbmc yosys-witness /home/charlotte/.local/bin
strip -S /home/charlotte/.local/bin/yosys
strip /home/charlotte/.local/bin/yosys-abc
strip /home/charlotte/.local/bin/yosys-filterlib
mkdir -p /home/charlotte/.local/share/yosys
cp -r share/. /home/charlotte/.local/share/yosys/.
</span><span class="gp">(venv) yosys $</span></code></pre>
<p>You may need to add <code>~/.local/bin</code> to your <code>PATH</code>. Test the installed binary.
Check the <code>yosys-config</code> output:</p>
<pre><code class="language-console"><span class="gp">(venv) yosys $</span><span class="w"> </span>yosys-config <span class="nt">--datdir</span>
<span class="go">/home/charlotte/.local/share/yosys
</span><span class="gp">(venv) yosys $</span></code></pre>
</section>
<section id="project-icestorm">
<h2>Project IceStorm <a href="#project-icestorm" aria-hidden="true" title="Permalink to section" class="anchor">üîó</a> <a href="#scope" aria-hidden="true" title="Back to scope" class="anchor">‚Ü©</a></h2>
<p>Before <a href="https://github.com/YosysHQ/nextpnr">nextpnr</a>, we need the technology-specific support. That‚Äôs this step.</p>
<p>Clone <a href="https://github.com/YosysHQ/icestorm">Project IceStorm</a>. There‚Äôs no <code>Makefile.conf</code> here, so edit the first
line of <code>config.mk</code>:</p>
<pre><code class="language-diff"><span class="gd">-PREFIX ?= /usr/local
</span><span class="gi">+PREFIX = $(HOME)/.local</span></code></pre>
<p>Install the libftdi development package; it‚Äôs <code>libftdi-dev</code> on Debian and
<code>libftdi</code> in Homebrew.</p>
<p>Now compile and install Project IceStorm. I‚Äôve avoided compiling in parallel as
its build script sometimes gets ahead of itself:</p>
<pre><code class="language-console?prompt=icestorm%20$"><span class="gp">(venv) icestorm $</span><span class="w"> </span>make
<span class="go">make -C icebox all
make[1]: Entering directory '/home/charlotte/icestorm/icebox'
python3 icebox_chipdb.py -3 &gt; chipdb-384.new
mv chipdb-384.new chipdb-384.txt

[... lots of output ...]

cc -MD -MP -O2  -Wall -std=c99 -I/home/charlotte/.local/include    -c -o mpsse.o mpsse.c
cc -o iceprog  iceprog.o mpsse.o -lm -lstdc++ -lftdi
make[1]: Leaving directory '/home/charlotte/icestorm/iceprog'
</span><span class="gp">(venv) icestorm $</span><span class="w"> </span>make <span class="nb">install</span>
<span class="go">for dir in icebox icepack icemulti icepll icebram icetime iceprog; do \
        make -C $dir install || exit; \
done
make[1]: Entering directory '/home/charlotte/icestorm/icebox'
mkdir -p /home/charlotte/.local/share/icebox

[... lots of output ...]

mkdir -p /home/charlotte/.local/bin
cp iceprog /home/charlotte/.local/bin/iceprog
make[1]: Leaving directory '/home/charlotte/icestorm/iceprog'
</span><span class="gp">(venv) icestorm $</span></code></pre>
<p>If you have an iCEBreaker, at this stage you can try using <code>iceprog</code> to say hi:</p>
<pre><code class="language-console"><span class="gp">(venv) icestorm $</span><span class="w"> </span>iceprog <span class="nt">-t</span>
<span class="go">init..
cdone: high
reset..
cdone: low
flash ID: 0xEF 0x40 0x18 0x00
cdone: high
Bye.
</span><span class="gp">(venv) icestorm $</span></code></pre>
</section>
<section id="troubleshooting">
<h3>Troubleshooting <a href="#troubleshooting" aria-hidden="true" title="Permalink to section" class="anchor">üîó</a> <a href="#scope" aria-hidden="true" title="Back to scope" class="anchor">‚Ü©</a></h3>
<p>The following error indicates the device wasn‚Äôt found by <code>iceprog</code>:</p>
<pre><code>init..
Can't find iCE FTDI USB device (vendor_id 0x0403, device_id 0x6010 or 0x6014).
ABORT.
</code></pre>
<p>macOS users, check System Information ‚Üí USB. If you don‚Äôt see the iCEBreaker
listed, check your connections and consider trying a different USB cable,
adaptor or hub, as appropriate.</p>
<p>Linux users, check <code>lsusb</code>. If you can see something with ID <code>0403:6010</code>, that‚Äôs
good. If it identifies itself as an iCEBreaker, even better. You may need a
<a href="https://opensource.com/article/18/11/udev">udev</a> rule to ensure the device node is writable by your user.</p>
<p>Create the file <code>/etc/udev/rules.d/53-lattice-ftdi.rules</code> with the following
content:</p>
<pre><code>ATTRS{idVendor}=="0403", ATTRS{idProduct}=="6010", MODE="0660", GROUP="plugdev", TAG+="uaccess"
</code></pre>
<p>This will make any device with ID <code>0403:6010</code> writable by the group <code>plugdev</code>.
Check the output of the <code>id</code> command to verify your user groups:</p>
<pre><code class="language-console"><span class="gp">(venv) icestorm $</span><span class="w"> </span><span class="nb">id</span> <span class="nt">-Gn</span>
<span class="go">charlotte adm sudo plugdev
</span><span class="gp">(venv) icestorm $</span></code></pre>
<p>If <code>plugdev</code> is listed somewhere, you‚Äôre good. Otherwise, add yourself to the
group. (e.g. <code>sudo adduser $(whoami) plugdev</code>) After this, unplug and replug for
the new rule to take effect.</p>
<p>WSL 2 users (or recalcitrant Windows users) should also consult the
footnote<sup class="footnote-ref"><a href="#fn-wslice" id="fnref-wslice" data-footnote-ref="">4</a></sup>.</p>
</section>
<section id="nextpnr">
<h2>nextpnr <a href="#nextpnr" aria-hidden="true" title="Permalink to section" class="anchor">üîó</a> <a href="#scope" aria-hidden="true" title="Back to scope" class="anchor">‚Ü©</a></h2>
<p>Ensure Project IceStorm (<a href="#project-icestorm">‚Ü¥</a>) is installed first.</p>
<p>Fetch <a href="https://github.com/YosysHQ/nextpnr">nextpnr</a> and install the appropriate <a href="https://github.com/YosysHQ/nextpnr#prerequisites">¬ß Prerequisites</a>. Then, check out
the specific instructions for <a href="https://github.com/YosysHQ/nextpnr#nextpnr-ice40">nextpnr-ice40</a>. We‚Äôll need to adapt them
slightly.</p>
<p>We specify the iCE40 arch, the install prefix, the install prefix for Project
IceStorm, the root directory for our active Python installation, and finally, a
<a href="https://duerrenberger.dev/blog/2021/08/04/understanding-rpath-with-cmake/">runtime search path</a> to add to the final binary. This is because nextpnr
will link against our Python install, but our Python install‚Äôs shared libraries
aren‚Äôt on the <a href="https://unix.stackexchange.com/a/22999/577154">system search path</a>.</p>
<pre><code class="language-console?prompt=nextpnr%20$,%20%20%20%20"><span class="gp">(venv) nextpnr $</span><span class="w"> </span>cmake <span class="nb">.</span> <span class="nt">-DARCH</span><span class="o">=</span>ice40 <span class="se">\</span>
<span class="gp">    </span><span class="w">             </span><span class="nt">-DCMAKE_INSTALL_PREFIX</span><span class="o">=</span><span class="nv">$HOME</span>/.local <span class="se">\</span>
<span class="gp">    </span><span class="w">             </span><span class="nt">-DICESTORM_INSTALL_PREFIX</span><span class="o">=</span><span class="nv">$HOME</span>/.local <span class="se">\</span>
<span class="gp">    </span><span class="w">             </span><span class="nt">-DPython3_ROOT_DIR</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span>asdf where python<span class="si">)</span><span class="s2">"</span> <span class="se">\</span>
<span class="gp">    </span><span class="w">             </span><span class="nt">-DCMAKE_INSTALL_RPATH</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span>asdf where python<span class="si">)</span><span class="s2">"</span>/lib
<span class="go">-- Building with IPO
-- Found Python3: /home/charlotte/.asdf/installs/python/3.11.4/bin/python3 (found suitable version "3.11.4", minimum required is "3.5") found components: Interpreter
-- Found Python3: /home/charlotte/.asdf/installs/python/3.11.4/include/python3.11 (found suitable version "3.11.4", minimum required is "3.5") found components: Development Development.Module Development.Embed
-- Found Boost: /usr/include (found version "1.74.0") found components: filesystem program_options iostreams system thread regex chrono date_time atomic
-- Found Boost: /usr/include (found version "1.74.0") found components: program_options filesystem system
-- Configuring architecture: ice40
-- Enabled iCE40 devices: 384;1k;5k;u4k;8k
-- Found Python3: /home/charlotte/.asdf/installs/python/3.11.4/bin/python3 (found suitable version "3.11.4", minimum required is "3.5") found components: Interpreter
-- IceStorm install prefix: /home/charlotte/.local
-- icebox data directory: /home/charlotte/.local/share/icebox
-- Using iCE40 chipdb: /home/charlotte/nextpnr/ice40/chipdb
-- Configuring architecture: ecp5
-- Enabled ECP5 devices: 25k;45k;85k
-- Trellis install prefix: /home/charlotte/.local
-- Trellis library directory: /usr/local/lib/trellis
-- Trellis data directory: /home/charlotte/.local/share/trellis
-- Using ECP5 chipdb: /home/charlotte/nextpnr/ecp5/chipdb
-- Configuring done
-- Generating done
-- Build files have been written to: /home/charlotte/nextpnr
</span><span class="gp">(venv) nextpnr $</span><span class="w"> </span>make <span class="nt">-j8</span>
<span class="go">[  2%] Generating chipdb/chipdb-384.bba
[  2%] Building CXX object bba/CMakeFiles/bbasm.dir/main.cc.o
[  4%] Generating chipdb/chipdb-1k.bba
[  5%] Linking CXX executable bbasm

[... lots of output ...]

[ 97%] Building CXX object CMakeFiles/nextpnr-ice40.dir/ice40/pack.cc.o
[ 98%] Building CXX object CMakeFiles/nextpnr-ice40.dir/ice40/pcf.cc.o
[100%] Linking CXX executable nextpnr-ice40
[100%] Built target nextpnr-ice40
</span><span class="gp">(venv) nextpnr $</span><span class="w"> </span>make <span class="nb">install</span>
<span class="go">[  7%] Built target chipdb-ice40-bbas
[ 10%] Built target bbasm
[ 17%] Built target chipdb-ice40-bins
[ 32%] Built target chipdb-ice40
[100%] Built target nextpnr-ice40
Install the project...
-- Install configuration: "Release"
-- Installing: /home/charlotte/.local/bin/nextpnr-ice40
-- Set runtime path of "/home/charlotte/.local/bin/nextpnr-ice40" to "/home/charlotte/.asdf/installs/python/3.11.4/lib"
</span><span class="gp">(venv) nextpnr $</span></code></pre>
<p>Test the installed binary to make sure it works.</p>
<pre><code class="language-console"><span class="gp">(venv) nextpnr $</span><span class="w"> </span>nextpnr-ice40
<span class="go">"nextpnr-ice40" -- Next Generation Place and Route (Version nextpnr-0.6-29-g54b20457)

General options:
  -h [ --help ]                         show help
  -v [ --verbose ]                      verbose output
  -q [ --quiet ]                        quiet mode, only errors and warnings
                                        displayed
  --Werror                              Turn warnings into errors
  -l [ --log ] arg                      log file, all log messages are written
                                        to this file regardless of -q

[... lots of output ...]

  --opt-timing                          run post-placement timing optimisation
                                        pass (experimental)
  --tmfuzz                              run path delay estimate fuzzer
  --pcf-allow-unconstrained             don't require PCF to constrain all IO

</span><span class="gp">(venv) nextpnr $</span></code></pre>
<p>At this point our Amaranth can now use our installed tooling to program the
iCEBreaker. The board definitions we installed earlier can be executed directly
to program a test blink gateware‚Äîdoing this exercises the full toolchain.
Verify:</p>
<pre><code class="language-console?prompt=nextpnr%20$"><span class="gp">(venv) nextpnr $</span><span class="w"> </span>python <span class="nt">-m</span> amaranth_boards.icebreaker
<span class="go">init..
cdone: high
reset..
cdone: low
flash ID: 0xEF 0x40 0x18 0x00
file size: 104090
erase 64kB sector at 0x000000..
erase 64kB sector at 0x010000..
programming..
done.
reading..
VERIFY OK
cdone: high
Bye.
</span><span class="gp">(venv) nextpnr $</span></code></pre>
</section>
<section id="symbiyosys">
<h2>SymbiYosys <a href="#symbiyosys" aria-hidden="true" title="Permalink to section" class="anchor">üîó</a> <a href="#scope" aria-hidden="true" title="Back to scope" class="anchor">‚Ü©</a></h2>
<p><a href="https://en.wikipedia.org/wiki/Formal_verification">Formal verification</a> can be orchestrated with SymbiYosys. To get started with
formal verification and Amaranth, have a look at <a href="https://github.com/RobertBaruch/amaranth-exercises">Robert Baruch‚Äôs graded
exercises for Amaranth HDL</a>, which start with formal methods
from the very first exercise. They use the tools we install here.</p>
<p><a href="https://github.com/YosysHQ/sby">SymbiYosys</a> is a relatively simple frontend, so fetch the repo and install. It
also has a Python dependency, <code>click</code>. Check that <code>sby -h</code> doesn‚Äôt give an
error:</p>
<pre><code class="language-console?prompt=sby%20$"><span class="gp">(venv) sby $</span><span class="w"> </span>make <span class="nv">PREFIX</span><span class="o">=</span><span class="nv">$HOME</span>/.local <span class="nb">install</span>
<span class="go">mkdir -p /home/charlotte/.local/bin
mkdir -p /home/charlotte/.local/share/yosys/python3
cp sbysrc/sby_*.py /home/charlotte/.local/share/yosys/python3/
sed -e 's|##yosys-program-prefix##|"''"|' &lt; sbysrc/sby_core.py &gt; /home/charlotte/.local/share/yosys/python3/sby_core.py
sed 's|##yosys-sys-path##|sys.path += [os.path.dirname(__file__) + p for p in ["/share/python3", "/../share/yosys/python3"]]|;' &lt; sbysrc/sby.py &gt; /home/charlotte/.local/bin/sby
chmod +x /home/charlotte/.local/bin/sby
</span><span class="gp">(venv) sby $</span><span class="w"> </span>pip <span class="nb">install </span>click
<span class="go">Collecting click
  Using cached click-8.1.3-py3-none-any.whl (96 kB)
Installing collected packages: click
Successfully installed click-8.1.3
</span><span class="gp">(venv) sby $</span><span class="w"> </span>sby <span class="nt">-h</span>
<span class="go">usage: sby [options] [&lt;jobname&gt;.sby [tasknames] | &lt;dirname&gt;]

positional arguments:
  &lt;jobname&gt;.sby | &lt;dirname&gt;

[... lots of output ...]

  --init-config-file INIT_CONFIG_FILE
                        create a default .sby config file
</span><span class="gp">(venv) sby $</span></code></pre>
<p>Check <code>sby -h</code> doesn‚Äôt give an error.</p>
</section>
<section id="z3">
<h2>Z3 <a href="#z3" aria-hidden="true" title="Permalink to section" class="anchor">üîó</a> <a href="#scope" aria-hidden="true" title="Back to scope" class="anchor">‚Ü©</a></h2>
<p><a href="https://github.com/Z3Prover/z3">Z3</a> is a <a href="https://en.wikipedia.org/wiki/Automated_theorem_proving">theorem prover</a> ‚Äî it does the heavy lifting of formal verification.
Clone the repo; we‚Äôre going to follow the <a href="https://github.com/Z3Prover/z3/blob/master/README-CMake.md">CMake instructions</a>.  The defaults
are all good, except for the install prefix:</p>
<pre><code class="language-console"><span class="gp">(venv) z3 $</span><span class="w"> </span><span class="nb">mkdir </span>build
<span class="gp">(venv) z3 $</span><span class="w"> </span><span class="nb">cd </span>build
<span class="gp">(venv) build $</span><span class="w"> </span>cmake .. <span class="nt">-DCMAKE_INSTALL_PREFIX</span><span class="o">=</span><span class="nv">$HOME</span>/.local
<span class="go">-- The CXX compiler identification is GNU 12.2.0
-- Detecting CXX compiler ABI info
-- Detecting CXX compiler ABI info - done
-- Check for working CXX compiler: /usr/bin/c++ - skipped
-- Detecting CXX compile features
-- Detecting CXX compile features - done
-- Z3 version 4.12.3.0

[... lots of output ...]

-- Configuring done
-- Generating done
-- Build files have been written to: /home/charlotte/z3/build
</span><span class="gp">(venv) build $</span><span class="w"> </span>make <span class="nt">-j8</span>
<span class="go">[  0%] Building CXX object src/util/CMakeFiles/util.dir/approx_set.cpp.o
[  0%] Building CXX object src/util/CMakeFiles/util.dir/approx_nat.cpp.o
[  0%] Building CXX object src/util/CMakeFiles/util.dir/debug.cpp.o

[... lots of output ...]

[ 98%] Linking CXX shared library ../libz3.so
[100%] Linking CXX executable ../../z3
[100%] Built target shell
[100%] Built target libz3
</span><span class="gp">(venv) build $</span><span class="w"> </span>make <span class="nb">install</span>
<span class="go">[  6%] Built target util
[  8%] Built target params
[  9%] Built target polynomial
[  9%] Built target automata

[... lots of output ...]

-- Installing: /home/charlotte/.local/include/z3_spacer.h
-- Installing: /home/charlotte/.local/include/z3_version.h
-- Installing: /home/charlotte/.local/bin/z3
</span><span class="gp">(venv) build $</span></code></pre>
<p>Done.</p>
</section>
<section id="overview">
<h2>Overview <a href="#overview" aria-hidden="true" title="Permalink to section" class="anchor">üîó</a> <a href="#scope" aria-hidden="true" title="Back to scope" class="anchor">‚Ü©</a></h2>
<p>You‚Äôre now ready to write and deploy gateware, with a toolchain selected, built
and installed by yourself in a self-contained and repeatable way.</p>
<p>There are many ways to pivot from here.</p>
<h5>You need a different Python version.</h5>
<p><code>asdf</code> and virtual environments make this easy.</p>
<h5>You want to understand Amaranth better.</h5>
<p>You can modify your editable install directly, adding print debugging.</p>
<h5>You need to write pure Verilog.</h5>
<p>You can drive Yosys yourself.</p>
<h5>You want to understand decisions made by Yosys better.</h5>
<p>You can step-through debug Yosys: run your Amaranth build once, then invoke
Yosys with your debugger of choice using the arguments from the generated
<code>build/build_top.sh</code>.</p>
<h5>You need to target a different family of boards.</h5>
<p>nextpnr <a href="https://github.com/YosysHQ/nextpnr#readme">supports</a> a range of architectures.</p>
<h5>You want to use a different solver with SymbiYosys.</h5>
<p>If it‚Äôs <a href="https://symbiyosys.readthedocs.io/en/latest/install.html#recommended-components">supported</a> and on your <code>PATH</code>, it‚Äôll work.</p>
</section>
<section class="footnotes" data-footnotes="" id="footnotes"><h2>Footnotes <a href="#footnotes" aria-hidden="true" title="Permalink to section" class="anchor">üîó</a> <a href="#scope" aria-hidden="true" title="Back to scope" class="anchor">‚Ü©</a></h2>
<ol>
<li id="fn-baby">
<p><em>baby‚Äôs first gateware</em>, in fact. <a href="#fnref-baby" class="footnote-backref" data-footnote-backref="" data-footnote-backref-idx="1" aria-label="Back to reference 1">‚Ü©</a></p>
</li>
<li id="fn-windows">
<ul>
<li>Lots of random things are a little bit broken.</li>
<li>Building Yosys is certainly achievable but <a href="https://github.com/YosysHQ/yosys/blob/2310a0ea9a61ed14d2769f01283a5a7590cbe558/guidelines/Windows">you simply don‚Äôt wanna</a>.</li>
<li>
<em>Everything runs slower</em>. Everything. Git runs slower. Python runs slower.
Batch scripts run slower. Yosys runs slower. <code>iceprog</code> communicates
(much!) slower.</li>
<li>Think you can fix some of this by using MSYS2 or Cygwin? Now you have two
problems.</li>
</ul>
<p>There‚Äôs more that I‚Äôve decided was better left forgotten. <a href="#fnref-windows" class="footnote-backref" data-footnote-backref="" data-footnote-backref-idx="2" aria-label="Back to reference 2">‚Ü©</a></p>
</li>
<li id="fn-wsl">
<p>tl;dr: use your Linux user home directory, not your Windows user one; if
CMake takes forever during configure, check if your <code>PATH</code> is full of
<code>/mnt/...</code> ‚Äî if it is, it‚Äôs probably searching your Windows partition very
slowly (disable <a href="https://learn.microsoft.com/en-us/windows/wsl/wsl-config#interop-settings"><code>interop.appendWindowsPath</code></a> or modify your <code>PATH</code> just for
configure); when it comes time to flash your board, follow the guide to
<a href="https://learn.microsoft.com/en-us/windows/wsl/connect-usb">Connect USB devices</a> using <a href="https://github.com/dorssel/usbipd-win">usbipd-win</a>. Don‚Äôt mind the scary warning on
the guide: I didn‚Äôt have to recompile my kernel even on Windows 10. <a href="#fnref-wsl" class="footnote-backref" data-footnote-backref="" data-footnote-backref-idx="3" aria-label="Back to reference 3">‚Ü©</a></p>
</li>
<li id="fn-wslice">
<p>Firstly, create (or edit) the file <code>/etc/wsl.conf</code> and ensure you
have the following stanza (or know what you‚Äôre doing already):</p>
<pre><code class="language-ini"><span class="nn">[boot]</span>
<span class="py">command</span><span class="p">=</span><span class="s">"service udev restart"</span></code></pre>
<p>Run <code>sudo service udev restart</code> to get udev going immediately. You can
<code>usbipd wsl detach -i 0403:6010</code> and then <code>attach</code> again instead of
physically messing around with cables.</p>
<p>This likely only applies to Windows Steelman Enthusiasts, but you <em>may</em> also
need to use <a href="https://zadig.akeo.ie/">Zadig</a>. Use the WinUSB driver. Check ‚ÄúList All Devices‚Äù in the
options menu. You should see two entries that correspond to the iCEBreaker ‚Äî
‚ÄúInterface 0‚Äù and ‚ÄúInterface 1‚Äù ‚Äî and they might identify themselves as the
iCEBreaker, or something less obvious (like ‚ÄúDual RS232-HS‚Äù). Make sure you
use the same driver for both. When in doubt, unplug and replug. <a href="#fnref-wslice" class="footnote-backref" data-footnote-backref="" data-footnote-backref-idx="4" aria-label="Back to reference 4">‚Ü©</a></p>
</li>
</ol>
</section>

      </main>
      <div class="sidebar">
        <div class="sidebar-inner">
          <ul>
            <li class=""><a href="./">Home</a></li>
            <li><a rel="me" href="https://lottia.net">Author</a></li>
          </ul>

          
            <h2>Notes</h2>
            <ul>
              
                <li class=""><a href="0010-vyxos.html">VyxOS</a></li>
              
                <li class=""><a href="0009-time-travel-raw.html">Time travel, raw</a></li>
              
                <li class=""><a href="0008-time-travel.html">Time travel</a></li>
              
                <li class=""><a href="0007-amaranth-to-chisel.html">Amaranth to Chisel</a></li>
              
                <li class=""><a href="0006-comrak-on-akkoma.html">Comrak on Akkoma</a></li>
              
                <li class=""><a href="0005-jambalam.html">Jambalam</a></li>
              
                <li class=""><a href="0004-happy-birthday.html">Happy birthday!</a></li>
              
                <li class=""><a href="0003-nix-revisited.html">Nix revisited</a></li>
              
                <li class=""><a href="0002-untangling-cycles.html">Untangling cycles</a></li>
              
                <li class="active"><a href="0001-hdl-toolchain-source.html">Installing an HDL toolchain from source</a></li>
              
            </ul>
          

          
        </div>

        
          <div class="toc">
            <div class="toc-inner">
              <h2>Table of contents</h2>

              <ul>
                <li>
                  <a href="#top">Top</a>
                  
                    
                      
                        </li><li>
                      
                      <a href="#scope">Scope</a>
                    
                  
                    
                      
                        </li><li>
                      
                      <a href="#git">Git</a>
                    
                  
                    
                      
                        </li><li>
                      
                      <a href="#python-3">Python 3</a>
                    
                  
                    
                      <ul><li>
                    
                  
                    
                      
                      <a href="#venv">venv</a>
                    
                  
                    
                      </li></ul>
                    
                  
                    
                      
                        </li><li>
                      
                      <a href="#amaranth">Amaranth</a>
                    
                  
                    
                      
                        </li><li>
                      
                      <a href="#yosys">Yosys</a>
                    
                  
                    
                      
                        </li><li>
                      
                      <a href="#project-icestorm">Project IceStorm</a>
                    
                  
                    
                      <ul><li>
                    
                  
                    
                      
                      <a href="#troubleshooting">Troubleshooting</a>
                    
                  
                    
                      </li></ul>
                    
                  
                    
                      
                        </li><li>
                      
                      <a href="#nextpnr">nextpnr</a>
                    
                  
                    
                      
                        </li><li>
                      
                      <a href="#symbiyosys">SymbiYosys</a>
                    
                  
                    
                      
                        </li><li>
                      
                      <a href="#z3">Z3</a>
                    
                  
                    
                      
                        </li><li>
                      
                      <a href="#overview">Overview</a>
                    
                  
                    
                      
                        </li><li>
                      
                      <a href="#footnotes">Footnotes</a>
                    
                  
                </li>
              </ul>
            </div>
          </div>
        
      </div>
    </div>
    <footer>
      <p>
        Licensed under the <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>
        by its author.
      </p>
    </footer>
    <script src="toc-highlight.js"></script>
  

</body></html>